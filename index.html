<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>Internet Monitor v1.8.1</title>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #111;
      --panel: #0b0b0b;
      --text: #eee;
      --border: #222;
    }

    .light {
      --bg: #f4f4f4;
      --panel: #ffffff;
      --text: #222;
      --border: #ccc;
    }

    body {
      background: var(--bg);
      color: var(--text);
      display: grid;
      grid-template-columns: 70% 30%;
      height: 100vh;
      margin: 0;
      font-family: Consolas, monospace;
      transition: background 0.3s, color 0.3s;
    }

    .panel {
      padding: 20px;
      border-right: 2px solid var(--border);
    }

    h2 {
      margin: 0 0 8px 0;
      color: var(--text);
    }

    #themeToggleBtn {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      margin-bottom: 10px;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    button, input {
      padding: 6px 10px;
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
    }

    button:hover {
      opacity: 0.85;
    }

    .log-btn {
      position: absolute;
      top: 10px;
      right: 20px;
    }

    .log-container {
      margin-top: 50px;
      overflow-y: auto;
      height: calc(100% - 70px);
    }

    .charts-wrap {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 6px;
    }

    .monitor-block {
      background: var(--panel);
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      display: flex;
      gap: 12px;
    }

    .monitor-meta {
      min-width: 220px;
      max-width: 220px;
    }

    .indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .indicator.online {
      background: limegreen;
      box-shadow: 0 0 6px limegreen;
    }

    .indicator.offline {
      background: red;
      box-shadow: 0 0 6px red;
    }

    .monitor-canvas {
      flex: 1;
      height: 160px;
    }

    .monitor-canvas canvas {
      width: 100% !important;
      height: 100% !important;
    }

    pre#logFile {
      background: #000;
      padding: 10px;
      border-radius: 8px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>

  <div class="panel" id="leftPanel">
    <button id="themeToggleBtn">üåô –¢–µ–º–∞</button>

    <div id="ipInfo" style="font-size:14px; margin-bottom:10px; opacity:0.85;">
      üåç –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è IP-—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó‚Ä¶
    </div>

<h2>üîç Internet Monitor v1.3.7</h2>

    <div class="controls">
      <div id="status">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</div>
      <button id="toggleNotificationsBtn">–í–∏–º–∫–Ω—É—Ç–∏ –Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó</button>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <label style="opacity:0.7;">–î–æ–¥–∞—Ç–∫–æ–≤—ñ:</label>
        <span id="extraCount">0</span>/3
      </div>
    </div>

    <div class="charts-wrap" id="chartsWrap"></div>

    <div style="margin-top:12px; display:flex; gap:8px;">
      <input id="newIpInput" type="text" placeholder="IP –∞–±–æ –¥–æ–º–µ–Ω">
      <button id="addMonitorBtn">‚ûï –î–æ–¥–∞—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä</button>
    </div>
  </div>

  <div class="panel" id="rightPanel">
    <h2>üìú –õ–æ–≥ –ø–æ–¥—ñ–π</h2>
    <button id="showLogBtn" class="log-btn">üìÅ –í—ñ–¥–∫—Ä–∏—Ç–∏ –ª–æ–≥</button>

    <div class="log-container">
      <ul id="log"></ul>
      <pre id="logFile"></pre>
    </div>
  </div>

  <audio id="soundOffline" src="vespene.mp3"></audio>
  <audio id="soundOnline" src="sc_marine.mp3"></audio>

  <script>
    const socket = io();

    // ======== Theme toggle =========
    const themeBtn = document.getElementById("themeToggleBtn");
    themeBtn.addEventListener("click", () => {
      document.body.classList.toggle("light");
      themeBtn.textContent = document.body.classList.contains("light")
        ? "‚òÄÔ∏è –¢–µ–º–∞"
        : "üåô –¢–µ–º–∞";
    });

    // ======== IP info ==============
    const ipInfoDiv = document.getElementById("ipInfo");

    async function updateIPinfo() {
      ipInfoDiv.style.opacity = "0.4";

      try {
        const res = await fetch("https://ipapi.co/json/");
        const data = await res.json();
        ipInfoDiv.textContent = `üåç ${data.ip} ‚Äî ${data.org || "–ù–µ–≤—ñ–¥–æ–º–∏–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä"} (${data.city || ""})`;
      } catch {
        ipInfoDiv.textContent = "üåç –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è IP-—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó";
      }

      setTimeout(() => ipInfoDiv.style.opacity = "1", 150);
    }

    updateIPinfo();
    setInterval(updateIPinfo, 30000);

    // ============================
    // –î–∞–ª—ñ ‚Äî —É–≤–µ—Å—å —Ç–≤—ñ–π —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π —Ä–æ–±–æ—á–∏–π JS –∑ v1.3.6
    // –Ω—ñ—á–æ–≥–æ –ù–ï –∑–º—ñ–Ω—é–≤–∞–≤ —É –ª–æ–≥—ñ—Ü—ñ, –≤—Å–µ –ø—Ä–∞—Ü—é—î
    // ============================

    const chartsWrap = document.getElementById('chartsWrap');
    const statusDiv = document.getElementById('status');
    const addBtn = document.getElementById('addMonitorBtn');
    const newIpInput = document.getElementById('newIpInput');
    const extraCountSpan = document.getElementById('extraCount');
    const showLogBtn = document.getElementById('showLogBtn');
    const logFile = document.getElementById('logFile');
    const logList = document.getElementById('log');
    const toggleBtn = document.getElementById('toggleNotificationsBtn');
    const soundOffline = document.getElementById('soundOffline');
    const soundOnline = document.getElementById('soundOnline');

    let notificationsEnabled = true;
    toggleBtn.textContent = '–í–∏–º–∫–Ω—É—Ç–∏ –Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó';

    let charts = {};
    let monitors = {};

    const COLORS = [
      'rgba(0,255,0,1)',
      'rgba(0,150,255,1)',
      'rgba(255,165,0,1)',
      'rgba(200,100,255,1)',
      'rgba(0,200,150,1)'
    ];

    addBtn.addEventListener('click', () => {
      const ip = newIpInput.value.trim();
      if (!ip) return alert('–í–≤–µ–¥—ñ—Ç—å IP –∞–±–æ –¥–æ–º–µ–Ω');
      socket.emit('addMonitor', ip);
      newIpInput.value = '';
    });

    newIpInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addBtn.click();
      }
    });

    function createMonitorBlock(m) {
      const block = document.createElement('div');
      block.className = 'monitor-block';
      block.id = 'mon-' + m.id;

      const meta = document.createElement('div');
      meta.className = 'monitor-meta';

      const h4 = document.createElement('h4');
      h4.innerHTML = `${m.target} <span id="ind-${m.id}" class="indicator"></span>`;
      meta.appendChild(h4);

      const small = document.createElement('small');
      small.id = `time-${m.id}`;
      small.textContent = '–æ—Å—Ç–∞–Ω–Ω—ñ–π: ‚Äî';
      meta.appendChild(small);

      if (m.type === 'extra') {
        const btn = document.createElement('button');
        btn.textContent = '‚ùå –í–∏–¥–∞–ª–∏—Ç–∏';
        btn.addEventListener('click', () => socket.emit('removeMonitor', m.id));
        meta.appendChild(btn);
      }

      const canvasWrap = document.createElement('div');
      canvasWrap.className = 'monitor-canvas';
      const canvas = document.createElement('canvas');
      canvas.id = 'c-' + m.id;
      canvasWrap.appendChild(canvas);

      block.appendChild(meta);
      block.appendChild(canvasWrap);
      chartsWrap.appendChild(block);

      const ctx = canvas.getContext('2d');
      const color = COLORS[Object.keys(charts).length % COLORS.length];

      const chart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{
          label: 'Ping (ms)',
          data: [],
          borderColor: color,
          backgroundColor: color.replace("1)", "0.15)"),
          segment: {
            borderColor: (ctx) => {
              const p0 = ctx.p0?.parsed?.y;
              const p1 = ctx.p1?.parsed?.y;
              return p0 === 0 || p1 === 0 ? "red" : color;
            }
          },
          tension: 0.2,
          pointRadius: 0
        }]},
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { min: 0, max: 300 }},
          plugins: { legend: { display: false }}
        }
      });

      charts[m.id] = { chart };
      monitors[m.id] = m;
      updateExtraCount();
    }

    function updateExtraCount() {
      const cnt = Object.values(monitors).filter(x => x.type === 'extra').length;
      extraCountSpan.textContent = cnt;
      addBtn.disabled = cnt >= 3;
    }

    function addPingToChart(id, value, timeStr) {
      const c = charts[id];
      if (!c) return;
      const chart = c.chart;

      chart.data.labels.push(timeStr);
      chart.data.datasets[0].data.push(value);

      if (chart.data.labels.length > 100) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }

      chart.update();
    }

    function setIndicator(id, alive) {
      const ind = document.getElementById("ind-" + id);
      if (ind) ind.className = "indicator " + (alive ? "online" : "offline");
    }

    toggleBtn.addEventListener('click', () => {
      notificationsEnabled = !notificationsEnabled;
      toggleBtn.textContent = notificationsEnabled ? '–í–∏–º–∫–Ω—É—Ç–∏ –Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó' : '–í–∫–ª—é—á–∏—Ç–∏ –Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó';
    });

    let logVisible = false;
    showLogBtn.addEventListener('click', async () => {
      if (!logVisible) {
        const res = await fetch('/log/today');
        logFile.textContent = res.ok ? await res.text() : '‚ö†Ô∏è –õ–æ–≥ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ.';
        logFile.style.display = 'block';
        showLogBtn.textContent = 'üìï –ó–∞–∫—Ä–∏—Ç–∏ –ª–æ–≥';
        logVisible = true;
      } else {
        logFile.style.display = 'none';
        showLogBtn.textContent = 'üìÅ –í—ñ–¥–∫—Ä–∏—Ç–∏ –ª–æ–≥';
        logVisible = false;
      }
    });

    socket.on('monitorList', (list) => {
      chartsWrap.innerHTML = '';
      charts = {};
      monitors = {};
      list.forEach(m => createMonitorBlock(m));
    });

    socket.on('monitorAdded', (m) => createMonitorBlock(m));
    socket.on('monitorRemoved', ({ id }) => {
      const el = document.getElementById('mon-' + id);
      if (el) el.remove();
      delete charts[id];
      delete monitors[id];
      updateExtraCount();
    });

    socket.on('pingData', (d) => {
      addPingToChart(d.id, d.alive ? d.responseTime : 0, d.time);
      setIndicator(d.id, d.alive);
      const t = document.getElementById('time-' + d.id);
      if (t) t.textContent = `–æ—Å—Ç–∞–Ω–Ω—ñ–π: ${d.time} ‚Äî ${d.alive ? d.responseTime + ' ms' : 'OFF'}`;
    });

    function playSound(a) {
      a.currentTime = 0;
      a.play().catch(() => {});
    }

    socket.on('log', (d) => {
      const li = document.createElement('li');
      li.textContent = `${d.time} ‚Äî ${d.status}`;
      logList.prepend(li);
      if (notificationsEnabled) {
        if (d.status.includes('‚ùå')) playSound(soundOffline);
        if (d.status.includes('‚úÖ')) playSound(soundOnline);
      }
    });
  </script>
</body>
</html>
